<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lector IA</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Panel del Lector IA</h1>
        <p class="user-info" id="user-info">Cargando...</p>
        
        <input type="text" id="sheetIdInput" placeholder="Pega el ID de tu Google Sheet aquí">
        <input type="file" id="imageInput" accept="image/*">
        <img id="preview" alt="Vista previa de la imagen">
        
        <button id="uploadButton" disabled>1. Selecciona Imagen y Sheet ID</button>
        <p id="status"></p>
        <a id="logout-button" class="button" style="background-color: #e44d3a;">Cerrar Sesión</a>
    </div>

    <script>
        // El CÓDIGO JavaScript empieza aquí
        const BACKEND_URL = "https://lector-ia-web.onrender.com"; 

        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const imageInput = document.getElementById('imageInput');
        const sheetIdInput = document.getElementById('sheetIdInput');
        const preview = document.getElementById('preview');
        const uploadButton = document.getElementById('uploadButton');
        const status = document.getElementById('status');
        let selectedFile;

        // --- NUEVA LÓGICA DE TOKENS EN EL FRONTEND ---
        async function checkLoginStatus() {
            // 1. Coge el token del almacenamiento local del navegador
            const token = localStorage.getItem('accessToken');

            // 2. Si no hay ningún token guardado, redirige a la página de inicio
            if (!token) {
                console.log("No hay token. Redirigiendo a index.html...");
                window.location.href = 'index.html';
                return;
            }

            try {
                // 3. Pide el perfil ENVIANDO el token en las cabeceras de la petición
                const profileRes = await fetch(`${BACKEND_URL}/api/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!profileRes.ok) {
                    // Si el backend dice que el token es inválido (error 401), lo borramos y redirigimos
                    localStorage.removeItem('accessToken'); 
                    throw new Error("Token no válido o expirado.");
                }

                const data = await profileRes.json();
                
                // 4. Si el token es válido, mostramos el dashboard
                console.log("Token válido. Mostrando dashboard.");
                userInfo.textContent = `Sesión iniciada como: ${data.email}`;
                
                // El botón de logout ahora debe borrar el token y redirigir
                logoutButton.addEventListener('click', () => {
                    localStorage.removeItem('accessToken');
                    window.location.href = 'index.html';
                });

            } catch (error) {
                console.error("Error al validar el token:", error);
                window.location.href = 'index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Al cargar la página, comprobamos si la URL contiene un token (ej: #token=...)
            const hash = window.location.hash;
            if (hash && hash.startsWith('#token=')) {
                // Si lo contiene, lo extraemos...
                const token = hash.substring(7); // Quita el '#token=' del principio
                // ...lo guardamos en el almacenamiento local...
                localStorage.setItem('accessToken', token);
                // ...y limpiamos la URL para que el token no se vea
                window.location.hash = ''; 
            }

            // Finalmente, comprobamos el estado del login
            checkLoginStatus();
        });
        
        // --- Lógica de la interfaz de usuario (casi sin cambios) ---
        function checkFormState() { if (selectedFile && sheetIdInput.value.trim() !== '') { uploadButton.disabled = false; uploadButton.textContent = 'Procesar y Guardar Datos'; } else { uploadButton.disabled = true; uploadButton.textContent = '1. Selecciona Imagen y Sheet ID'; } }
        imageInput.addEventListener('change', (event) => { selectedFile = event.target.files[0]; if (selectedFile) { preview.src = URL.createObjectURL(selectedFile); preview.style.display = 'block'; } checkFormState(); });
        sheetIdInput.addEventListener('input', checkFormState);

        uploadButton.addEventListener('click', async () => {
            if (!selectedFile || !sheetIdInput.value) return;

            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("Error de sesión. Por favor, inicia sesión de nuevo.");
                window.location.href = 'index.html';
                return;
            }

            uploadButton.disabled = true;
            status.textContent = 'Subiendo y procesando...';
            
            const formData = new FormData();
            formData.append('image', selectedFile);
            formData.append('sheetId', sheetIdInput.value.trim());

            try {
                // Añadimos la cabecera de Autorización con el token al enviar la imagen
                const response = await fetch(`${BACKEND_URL}/api/process-image`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    status.textContent = result.message;
                    status.style.color = 'green';
                } else {
                    status.textContent = `Error: ${result.error}`;
                    status.style.color = 'red';
                }
            } catch (error) {
                status.textContent = 'Error de conexión con el servidor.';
                status.style.color = 'red';
            } finally {
                uploadButton.disabled = false;
            }
        });
    </script>

</body>
</html>