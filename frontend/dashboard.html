<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lector IA</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos adicionales para la nueva interfaz */
        .section { border-top: 1px solid #ddd; margin-top: 20px; padding-top: 20px; }
        #results-form .form-group { margin-bottom: 10px; text-align: left; }
        #results-form label { font-weight: bold; display: block; margin-bottom: 5px; }
        #results-form input { width: calc(100% - 22px); }
        select { width: 100%; padding: 10px; margin-top: 15px; border-radius: 6px; }
    </style>
    <!-- Importamos la librería para comprimir imágenes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js" integrity="sha512-MgYeYFj8R3S6rvZHiJ1adMGO_OizWFaSbIea9sOTf2I3GK1uaRswiPbaL5J+I1052B1fL/0Gz3er1Lz3G7Qn+Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="container">
        <h1>Panel del Lector IA</h1>
        <p class="user-info" id="user-info">Cargando...</p>
        <a id="logout-button" class="button" style="background-color: #e44d3a; display: none;">Cerrar Sesión</a>
        
        <!-- SECCIÓN 1: GESTIÓN DE SHEETS -->
        <div class="section">
            <h2>1. Selecciona o Añade una Hoja de Cálculo</h2>
            <div id="sheets-loader" style="display: none;">Cargando tus sheets...</div>
            <select id="sheets-dropdown" style="display: none;"></select>
            <div id="add-sheet-form">
                <input type="text" id="new-sheet-id" placeholder="Pega el ID de una nueva Google Sheet">
                <button id="add-sheet-btn">Añadir y Analizar Sheet</button>
            </div>
        </div>

        <!-- SECCIÓN 2: SUBIR IMAGEN -->
        <div id="upload-section" class="section" style="display: none;">
            <h2>2. Sube una Imagen para Extraer Datos</h2>
            <input type="file" id="imageInput" accept="image/*">
            <img id="preview" alt="Vista previa de la imagen" style="display: none;">
            <button id="extract-btn" disabled>Extraer Datos</button>
        </div>

        <!-- SECCIÓN 3: VERIFICAR Y GUARDAR DATOS -->
        <div id="results-section" class="section" style="display: none;">
            <h2>3. Verifica los Datos Extraídos</h2>
            <form id="results-form"></form> <!-- Los campos se generarán aquí -->
            <button id="save-btn">Guardar en Sheet</button>
        </div>

        <p id="status"></p>
    </div>

    <script>
        const BACKEND_URL = "https://lector-ia-web.onrender.com";
        // Obtenemos todos los elementos del DOM que vamos a manipular
        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const sheetsLoader = document.getElementById('sheets-loader');
        const sheetsDropdown = document.getElementById('sheets-dropdown');
        const addSheetForm = document.getElementById('add-sheet-form');
        const newSheetIdInput = document.getElementById('new-sheet-id');
        const addSheetBtn = document.getElementById('add-sheet-btn');
        const uploadSection = document.getElementById('upload-section');
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const extractBtn = document.getElementById('extract-btn');
        const resultsSection = document.getElementById('results-section');
        const resultsForm = document.getElementById('results-form');
        const saveBtn = document.getElementById('save-btn');
        const status = document.getElementById('status');
        
        let token = null;
        let userSheets = [];
        let currentSelectedSheet = null;
        let extractedData = null;
        let compressedImageFile = null; // Variable para guardar la imagen ya comprimida

        // --- LÓGICA PRINCIPAL AL CARGAR LA PÁGINA ---
        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#token=')) {
                token = hash.substring(7);
                localStorage.setItem('accessToken', token);
                window.location.hash = '';
            } else {
                token = localStorage.getItem('accessToken');
            }

            if (!token) {
                window.location.href = 'index.html';
            } else {
                userInfo.textContent = "Verificando sesión...";
                loadUserSheets();
            }
        });

        // --- FUNCIONES DE LA APP ---

        // Función central para hacer llamadas a nuestra API de forma segura
        async function apiFetch(endpoint, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            const response = await fetch(`${BACKEND_URL}${endpoint}`, options);
            if (response.status === 401) { // Si el token es inválido, deslogueamos
                localStorage.removeItem('accessToken');
                window.location.href = 'index.html';
                throw new Error("No autorizado");
            }
            return response;
        }

        // Carga las sheets guardadas del usuario desde el backend
        async function loadUserSheets() {
            sheetsLoader.style.display = 'block';
            try {
                const response = await apiFetch('/api/sheets');
                userSheets = await response.json();
                
                userInfo.textContent = "¡Bienvenido!";
                logoutButton.style.display = 'inline-block';
                
                if (userSheets.length > 0) {
                    populateSheetsDropdown();
                    sheetsDropdown.style.display = 'block';
                    handleSheetSelection();
                } else {
                    userInfo.textContent += " Añade tu primera Sheet para empezar.";
                }
            } catch (e) {
                status.textContent = "Error al cargar tus sheets.";
            } finally {
                sheetsLoader.style.display = 'none';
            }
        }

        // Rellena el menú desplegable con las sheets del usuario
        function populateSheetsDropdown() {
            sheetsDropdown.innerHTML = userSheets.map(s => `<option value="${s.sheet_id}">${s.sheet_name}</option>`).join('');
        }

        // Se ejecuta cuando el usuario selecciona una sheet del menú
        function handleSheetSelection() {
            const selectedId = sheetsDropdown.value;
            currentSelectedSheet = userSheets.find(s => s.sheet_id === selectedId);
            uploadSection.style.display = 'block';
            resultsSection.style.display = 'none';
            imageInput.value = '';
            preview.style.display = 'none';
            extractBtn.disabled = true;
            compressedImageFile = null;
        }

        // --- EVENT LISTENERS (INTERACCIONES DEL USUARIO) ---

        // Botón para añadir una nueva sheet
        addSheetBtn.addEventListener('click', async () => {
            const newSheetId = newSheetIdInput.value.trim();
            if (!newSheetId) { alert("Por favor, introduce un ID de Sheet."); return; }
            
            status.textContent = "Analizando nueva sheet...";
            addSheetBtn.disabled = true;
            try {
                const response = await apiFetch('/api/sheets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_id: newSheetId })
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "No se pudo analizar la sheet.");
                }
                
                newSheetIdInput.value = '';
                status.textContent = "¡Sheet añadida con éxito!";
                loadUserSheets(); // Recargar la lista para que aparezca la nueva
            } catch (e) {
                status.textContent = `Error: ${e.message}`;
            } finally {
                addSheetBtn.disabled = false;
            }
        });

        sheetsDropdown.addEventListener('change', handleSheetSelection);

        // Input de archivo: comprime la imagen al seleccionarla
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                extractBtn.disabled = true;
                compressedImageFile = null;
                return;
            }

            status.textContent = "Comprimiendo imagen para optimizar...";
            extractBtn.disabled = true;
            
            new Compressor(file, {
                quality: 0.8,       // Calidad del 80% (buen balance)
                maxWidth: 1600,     // Ancho máximo
                maxHeight: 1600,    // Alto máximo
                success(result) {
                    compressedImageFile = result; // Guardamos el archivo comprimido
                    preview.src = URL.createObjectURL(result);
                    preview.style.display = 'block';
                    extractBtn.disabled = false;
                    status.textContent = "Imagen lista para extraer.";
                },
                error(err) {
                    status.textContent = "Error al procesar la imagen.";
                    compressedImageFile = null;
                },
            });
        });

        // Botón para extraer datos
        extractBtn.addEventListener('click', async () => {
            if (!compressedImageFile || !currentSelectedSheet) return;
            
            status.textContent = "Extrayendo datos con IA... Esto puede tardar unos segundos.";
            extractBtn.disabled = true;
            resultsSection.style.display = 'none';
            
            const formData = new FormData();
            formData.append('image', compressedImageFile, compressedImageFile.name);
            formData.append('columns', JSON.stringify(currentSelectedSheet.columns));
            
            try {
                const response = await apiFetch('/api/extract', { method: 'POST', body: formData });
                 if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "La extracción con IA falló.");
                }
                
                extractedData = await response.json();
                displayResultsForm();
                status.textContent = "Datos extraídos. Por favor, verifica y corrige si es necesario.";
            } catch (e) {
                status.textContent = `Error: ${e.message}`;
            } finally {
                extractBtn.disabled = false;
            }
        });

        // Muestra el formulario con los resultados de la IA
        function displayResultsForm() {
            resultsForm.innerHTML = ''; // Limpiar formulario anterior
            for (const column of currentSelectedSheet.columns) {
                const value = extractedData[column] || '';
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.innerHTML = `
                    <label for="field-${column}">${column}</label>
                    <input type="text" id="field-${column}" name="${column}" value="${value}">
                `;
                resultsForm.appendChild(formGroup);
            }
            resultsSection.style.display = 'block';
        }

        // Botón para guardar los datos finales en la sheet
        saveBtn.addEventListener('click', async () => {
            const finalData = {};
            for (const column of currentSelectedSheet.columns) {
                finalData[column] = document.getElementById(`field-${column}`).value;
            }
            
            status.textContent = "Guardando en Google Sheets...";
            saveBtn.disabled = true;

            try {
                const response = await apiFetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sheet_id: currentSelectedSheet.sheet_id,
                        columns: currentSelectedSheet.columns,
                        data: finalData
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "No se pudo guardar.");
                }
                
                status.textContent = "¡Datos guardados con éxito!";
                // Reseteamos para la siguiente imagen
                resultsSection.style.display = 'none';
                imageInput.value = '';
                preview.style.display = 'none';
                extractBtn.disabled = true;
                compressedImageFile = null;
            } catch(e) {
                status.textContent = `Error: ${e.message}`;
            } finally {
                saveBtn.disabled = false;
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('accessToken');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>